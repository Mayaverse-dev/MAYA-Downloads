<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - MAYA Pledge Manager</title>
    <meta name="description" content="Secure payment for your MAYA order. Complete your pledge with card payment.">
    <meta name="theme-color" content="#0A0A0A">
    <meta name="robots" content="noindex, nofollow">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://store.entermaya.com/payment">
    <meta property="og:title" content="Payment - MAYA Store">
    <meta property="og:description" content="Secure payment for your MAYA order.">
    <meta property="og:image" content="https://store.entermaya.com/images/hero/divya.png">
    <meta property="og:site_name" content="MAYA Store">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Payment - MAYA Store">
    <meta name="twitter:image" content="https://store.entermaya.com/images/hero/divya.png">
    <meta name="twitter:site" content="@maya_lore_">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    <!-- Fonts - Preconnect for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/style.css">
    <script>
        // Suppress Stripe telemetry errors (often caused by ad blockers)
        window.addEventListener('unhandledrejection', function (event) {
            if (event.reason && (
                (event.reason.message && event.reason.message.includes('r.stripe.com')) ||
                (event.reason.stack && event.reason.stack.includes('stripe'))
            )) {
                event.preventDefault();
                console.warn('Stripe telemetry blocked (likely by ad blocker). Payment functionality should still work.');
            }
        });
    </script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="/js/app.js"></script>
    <style>
        /* ===== CHECKOUT FLOW SHARED STYLES ===== */
        .checkout-wrapper {
            max-width: 960px;
            margin: 0 auto;
            padding: 0 24px 80px;
        }

        /* Progress Steps */
        .checkout-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 48px;
            padding: 20px 0;
        }

        .checkout-step {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkout-step-num {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            background: var(--matter);
            border: 2px solid var(--border);
            color: var(--text-dim);
        }

        .checkout-step-num.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .checkout-step-num.done {
            background: var(--text-main);
            border-color: var(--text-main);
            color: var(--void);
        }

        .checkout-step-text {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .checkout-step-text.active {
            color: var(--accent);
        }

        .checkout-step-text.done {
            color: var(--text-main);
        }

        .checkout-step-line {
            width: 60px;
            height: 2px;
            background: var(--border);
            margin: 0 16px;
        }

        .checkout-step-line.done {
            background: var(--text-main);
        }

        /* Two Column Layout */
        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 32px;
            align-items: start;
        }

        /* Main Panel */
        .checkout-main {
            background: var(--matter);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .checkout-main-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .checkout-main-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .checkout-main-body {
            padding: 24px;
        }

        /* Summary Panel */
        .checkout-summary {
            background: var(--matter);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: sticky;
            top: 100px;
        }

        .checkout-summary-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 20px;
        }

        .checkout-summary-items {
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .checkout-summary-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--void);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .checkout-summary-item-img {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .checkout-summary-item-img svg {
            width: 18px;
            height: 18px;
            color: var(--text-dim);
        }

        .checkout-summary-item-info {
            flex: 1;
            min-width: 0;
        }

        .checkout-summary-item-name {
            font-size: 0.8rem;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .checkout-summary-item-qty {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
        }

        .checkout-summary-item-price {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-main);
        }

        .checkout-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .checkout-summary-row+.checkout-summary-row {
            border-top: 1px dashed var(--border);
        }

        .checkout-summary-label {
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .checkout-summary-value {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-main);
        }

        .checkout-summary-row.total {
            border-top: 2px solid var(--border);
            padding-top: 16px;
            margin-top: 8px;
        }

        .checkout-summary-row.total .checkout-summary-label {
            font-weight: 600;
            color: var(--text-main);
        }

        .checkout-summary-row.total .checkout-summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* ===== PAYMENT SPECIFIC STYLES ===== */

        /* Form Styles */
        .form-section-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px dashed var(--border);
        }

        .form-label {
            display: block;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 10px;
        }

        /* Stripe Card Element */
        .card-input-container {
            background: var(--void);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 18px;
            transition: border-color 0.2s ease;
            margin-bottom: 20px;
        }

        .card-input-container:focus-within {
            border-color: var(--accent);
        }

        #card-element {
            min-height: 20px;
        }

        .card-error {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            color: #EF4444;
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .card-error.visible {
            opacity: 1;
        }

        /* Save Card Toggle */
        .toggle-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 14px 16px;
            background: var(--void);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 24px;
        }

        .toggle-text span {
            display: block;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            color: var(--text-main);
        }

        .toggle-text small {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
        }

        .pill-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .pill-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .pill-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border);
            transition: 0.2s ease;
            border-radius: 24px;
        }

        .pill-slider::before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: var(--text-dim);
            transition: 0.2s ease;
            border-radius: 50%;
        }

        .pill-toggle input:checked+.pill-slider {
            background: var(--accent);
        }

        .pill-toggle input:checked+.pill-slider::before {
            transform: translateX(20px);
            background: white;
        }

        /* Saved Cards */
        .saved-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--void);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 10px;
        }

        .saved-card:hover {
            border-color: var(--border-hover);
        }

        .saved-card.selected {
            border-color: var(--accent);
            background: rgba(230, 30, 37, 0.03);
        }

        .saved-card input[type="radio"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
        }
        
        .replacing-card-notice {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: rgba(230, 30, 37, 0.05);
            border: 1px dashed var(--accent);
            border-radius: 10px;
            margin-bottom: 16px;
        }
        
        .replacing-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 9px;
            letter-spacing: 0.1em;
            color: var(--accent);
            background: rgba(230, 30, 37, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .replacing-card {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            color: var(--text-dim);
            text-decoration: line-through;
        }

        .card-brand-icon {
            width: 36px;
            height: 26px;
            background: var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-brand-icon svg {
            width: 20px;
            height: 20px;
            color: var(--text-dim);
        }

        .card-info {
            flex: 1;
        }

        .card-number {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-main);
        }

        .card-expiry {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
        }

        .add-card-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 10px;
            color: var(--text-dim);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 20px;
        }

        .add-card-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .new-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .new-card-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .cancel-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            cursor: pointer;
        }

        .cancel-btn:hover {
            border-color: var(--text-dim);
            color: var(--text-main);
        }

        /* Pay Button */
        .checkout-btn {
            width: 100%;
            height: 52px;
            border: none;
            background: var(--accent);
            color: white;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s ease;
            position: relative;
        }

        .checkout-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(230, 30, 37, 0.25);
        }

        .checkout-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .checkout-btn.loading .btn-text {
            opacity: 0;
        }

        .checkout-btn.loading::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Trust Line */
        .trust-line {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 16px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
        }

        .trust-line svg {
            width: 12px;
            height: 12px;
        }

        .checkout-back-link {
            text-align: center;
            margin-top: 16px;
        }

        .checkout-back-link a {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            letter-spacing: 0.03em;
            color: var(--text-dim);
            text-decoration: none;
        }

        .checkout-back-link a:hover {
            color: var(--text-main);
        }

        /* Mobile */
        @media (max-width: 800px) {
            .checkout-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .checkout-summary {
                position: static;
                order: -1;
            }

            .checkout-step-line {
                width: 40px;
                margin: 0 10px;
            }

            .checkout-step-text {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="beta-tag">BETA v0.9</div>
    <div id="navbar">
        <a href="/" class="logo-container">
            <img src="/images/maya-logo.png" alt="MAYA">
        </a>
        <div class="flex items-center gap-4">
            <a href="/checkout" class="nav-btn">BACK</a>
        </div>
    </div>

    <div class="checkout-wrapper">
        <!-- Progress Steps -->
        <div class="checkout-progress">
            <div class="checkout-step">
                <div class="checkout-step-num done">
                    <svg style="width: 14px; height: 14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <span class="checkout-step-text done">Cart</span>
            </div>
            <div class="checkout-step-line done"></div>
            <div class="checkout-step">
                <div class="checkout-step-num done">
                    <svg style="width: 14px; height: 14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <span class="checkout-step-text done">Shipping</span>
            </div>
            <div class="checkout-step-line done"></div>
            <div class="checkout-step">
                <div class="checkout-step-num active">3</div>
                <span class="checkout-step-text active">Payment</span>
            </div>
        </div>

        <div class="checkout-grid">
            <!-- Main Panel -->
            <div class="checkout-main">
                <div class="checkout-main-header">
                    <div class="checkout-main-title">Payment Method</div>
                </div>

                <div class="checkout-main-body">
                    <!-- Saved Cards Section -->
                    <div id="saved-cards-section" class="hidden">
                        <div id="saved-cards-list"></div>
                        <button type="button" id="add-new-card-btn" class="add-card-btn">
                            <svg style="width: 14px; height: 14px;" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Add New Card
                        </button>
                    </div>

                    <!-- New Card Entry -->
                    <div id="new-card-section">
                        <div id="new-card-header" class="new-card-header hidden">
                            <span class="new-card-label">New Card</span>
                            <button type="button" id="cancel-new-card-btn" class="cancel-btn">Cancel</button>
                        </div>

                        <div>
                            <label class="form-label">Card Information</label>
                            <div class="card-input-container">
                                <div id="card-element"></div>
                            </div>
                            <div id="card-errors" class="card-error">
                                <svg style="width: 14px; height: 14px;" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span></span>
                            </div>
                        </div>

                        <div class="toggle-option">
                            <div class="toggle-text">
                                <span>Save card for future</span>
                                <small>Securely stored by Stripe</small>
                            </div>
                            <label class="pill-toggle">
                                <input type="checkbox" id="save-card-checkbox" checked>
                                <span class="pill-slider"></span>
                            </label>
                        </div>
                    </div>

                    <button type="button" id="pay-btn" class="checkout-btn" onclick="handlePayment()">
                        <span class="btn-text">PAY $<span id="pay-amount">0.00</span></span>
                    </button>

                    <div class="trust-line">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        Secured by Stripe
                    </div>
                </div>
            </div>

            <!-- Summary Panel -->
            <div class="checkout-summary">
                <div class="checkout-summary-title">/// Order Summary</div>

                <div class="checkout-summary-items" id="order-items"></div>

                <div>
                    <div class="checkout-summary-row">
                        <span class="checkout-summary-label">Subtotal</span>
                        <span class="checkout-summary-value" id="subtotal">$0.00</span>
                    </div>
                    <div class="checkout-summary-row">
                        <span class="checkout-summary-label">Shipping</span>
                        <span class="checkout-summary-value" id="shipping">$0.00</span>
                    </div>
                    <div class="checkout-summary-row total">
                        <span class="checkout-summary-label">Total</span>
                        <span class="checkout-summary-value" id="total">$0.00</span>
                    </div>
                </div>

                <div class="checkout-back-link" style="margin-top: 20px;">
                    <a href="/checkout">← Edit Shipping</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let stripe, elements, card, paymentIntentId, clientSecret, savedCard = null, usingSavedCard = false;
        let currentCartTotal = 0, currentShippingCost = 0;
        // Store data needed for payment intent creation
        let paymentPayload = null;
        let userData = null;

        async function init() {
            try {
                App.Cart.init();

                let items = App.Cart.items || [];
                let isShippingOnly = false;

                // Check if user is a paid backer (for shipping-only flow)
                try {
                    const userRes = await fetch('/api/user/data');
                    if (userRes.ok) {
                        userData = await userRes.json();
                    }
                } catch (e) {
                    console.log('Not logged in');
                }

                // Allow shipping-only for paid backers
                if (!items || items.length === 0) {
                    const isPaidBacker = userData && userData.rewardTitle &&
                        (userData.pledgedStatus === 'collected' || userData.profileType === 'collected' || userData.profileType === 'pot');

                    if (!isPaidBacker) {
                        alert('Your cart is empty. Redirecting to store...');
                        window.location.href = '/';
                        return;
                    }
                    isShippingOnly = true;
                }

                const shippingAddress = JSON.parse(sessionStorage.getItem('shippingAddress') || '{}');
                if (!shippingAddress.email || !shippingAddress.country) {
                    alert('Shipping information missing. Please complete shipping details.');
                    window.location.href = '/checkout';
                    return;
                }

                // Initialize Stripe Elements (card input UI only - no payment intent yet)
                const res = await fetch('/api/stripe-key');
                const { publishableKey } = await res.json();

                stripe = Stripe(publishableKey);
                elements = stripe.elements({
                    fonts: [{ cssSrc: 'https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&display=swap' }]
                });

                const style = {
                    base: {
                        color: "#FAFAFA",
                        fontFamily: '"IBM Plex Mono", monospace',
                        fontSmoothing: "antialiased",
                        fontSize: "15px",
                        "::placeholder": { color: "#666666" },
                        iconColor: "#666666"
                    },
                    invalid: { color: "#EF4444", iconColor: "#EF4444" }
                };

                card = elements.create("card", { style, hidePostalCode: true });
                card.mount("#card-element");

                card.on('change', function (event) {
                    const displayError = document.getElementById('card-errors');
                    const errorSpan = displayError.querySelector('span');
                    if (event.error) {
                        displayError.classList.add('visible');
                        if (errorSpan) errorSpan.textContent = event.error.message;
                    } else {
                        displayError.classList.remove('visible');
                        if (errorSpan) errorSpan.textContent = '';
                    }
                });

                await loadSavedCards();

                // Calculate and display totals (client-side for display only)
                currentCartTotal = App.Cart.calculateTotal();
                currentShippingCost = parseFloat(sessionStorage.getItem('shippingCost')) || 0;
                let totalAmount = currentCartTotal + currentShippingCost;

                // Handle shipping-only flow
                if (isShippingOnly && userData) {
                    document.getElementById('subtotal').textContent = '$0.00';
                    document.getElementById('shipping').textContent = '$' + currentShippingCost.toFixed(2);
                    document.getElementById('total').textContent = '$' + currentShippingCost.toFixed(2);

                    document.getElementById('order-items').innerHTML = `
                        <div class="checkout-summary-item" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div class="checkout-summary-item-img" style="background: var(--text-main);">
                                <svg fill="none" stroke="var(--void)" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                            <div class="checkout-summary-item-info">
                                <div class="checkout-summary-item-name">${userData.rewardTitle}</div>
                                <div class="checkout-summary-item-qty">Kickstarter Pledge</div>
                            </div>
                            <div class="checkout-summary-item-price">Paid</div>
                        </div>
                    `;

                    totalAmount = currentShippingCost;
                    document.getElementById('pay-amount').textContent = currentShippingCost.toFixed(2);
                } else {
                    document.getElementById('subtotal').textContent = '$' + currentCartTotal.toFixed(2);
                    document.getElementById('shipping').textContent = '$' + currentShippingCost.toFixed(2);
                    document.getElementById('total').textContent = '$' + totalAmount.toFixed(2);

                    // Check if dropped or canceled backer (both need to pay for their pledge)
                    const isDroppedBacker = userData && (
                        ['dropped', 'canceled'].includes(userData.pledgedStatus) ||
                        ['dropped', 'canceled'].includes(userData.profileType)
                    );

                    document.getElementById('order-items').innerHTML = items.map(i => {
                        const isOriginalPledge = i.isOriginalPledge && isDroppedBacker;
                        const bgStyle = isOriginalPledge ? 'background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.2);' : '';
                        const iconBg = isOriginalPledge ? 'background: #EAB308;' : '';
                        const textColor = isOriginalPledge ? 'color: #EAB308;' : '';
                        const qtyText = isOriginalPledge ? 'Pledge Payment' : `Qty: ${i.quantity}`;

                        return `
                        <div class="checkout-summary-item" style="${bgStyle}">
                            <div class="checkout-summary-item-img" style="${iconBg}">
                                <svg fill="none" stroke="${isOriginalPledge ? 'white' : 'currentColor'}" viewBox="0 0 24 24">
                                    ${isOriginalPledge
                                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'
                                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>'}
                                </svg>
                            </div>
                            <div class="checkout-summary-item-info">
                                <div class="checkout-summary-item-name" style="${textColor}">${i.name}</div>
                                <div class="checkout-summary-item-qty" style="${textColor}">${qtyText}</div>
                            </div>
                            <div class="checkout-summary-item-price" style="${textColor}">$${(i.price * i.quantity).toFixed(0)}</div>
                        </div>
                    `}).join('');

                    document.getElementById('pay-amount').textContent = totalAmount.toFixed(2);
                }

                // Store payload for later use when user clicks Pay
                paymentPayload = {
                    amount: totalAmount,
                    cartItems: isShippingOnly ? [] : items,
                    shippingAddress: shippingAddress,
                    shippingCost: currentShippingCost,
                    isShippingOnly: isShippingOnly
                };

                console.log('✓ Payment page ready (Payment Intent will be created on Pay click)');

            } catch (err) {
                console.error("Payment setup error:", err);
                alert('Payment setup failed: ' + err.message);
            }
        }

        async function loadSavedCards() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const isReplacing = urlParams.get('replace') === 'true';
                
                const userRes = await fetch('/api/user/session');
                const userData = await userRes.json();

                if (!userData.isLoggedIn) {
                    document.getElementById('new-card-section').classList.remove('hidden');
                    return;
                }

                const savedResponse = await fetch('/api/user/payment-methods');
                const { paymentMethods } = await savedResponse.json();

                const cardsList = document.getElementById('saved-cards-list');
                const savedCardsSection = document.getElementById('saved-cards-section');
                const newCardSection = document.getElementById('new-card-section');

                // If replacing card, show new card form directly
                if (isReplacing) {
                    newCardSection.classList.remove('hidden');
                    document.getElementById('new-card-header').classList.remove('hidden');
                    usingSavedCard = false;
                    
                    // Show existing card info if available
                    if (paymentMethods && paymentMethods.length > 0) {
                        const existingCard = paymentMethods[0];
                        const brandUpper = existingCard.brand.charAt(0).toUpperCase() + existingCard.brand.slice(1);
                        cardsList.innerHTML = `
                            <div class="replacing-card-notice">
                                <span class="replacing-label">REPLACING</span>
                                <span class="replacing-card">${brandUpper} •••• ${existingCard.last4}</span>
                            </div>
                        `;
                        savedCardsSection.classList.remove('hidden');
                    }
                    return;
                }

                if (paymentMethods && paymentMethods.length > 0) {
                    savedCardsSection.classList.remove('hidden');
                    cardsList.innerHTML = paymentMethods.map((cardData, index) => {
                        const brandUpper = cardData.brand.charAt(0).toUpperCase() + cardData.brand.slice(1);
                        const isSelected = index === 0;
                        if (isSelected) savedCard = cardData;

                        return `
                            <label class="saved-card ${isSelected ? 'selected' : ''}" data-pm-id="${cardData.paymentMethodId}">
                                <input type="radio" name="selected-card" value="${cardData.paymentMethodId}" ${isSelected ? 'checked' : ''} onchange="selectCard('${cardData.paymentMethodId}')">
                                <div class="card-brand-icon">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                    </svg>
                                </div>
                                <div class="card-info">
                                    <div class="card-number">${brandUpper} •••• ${cardData.last4}</div>
                                    <div class="card-expiry">Expires ${cardData.expMonth}/${cardData.expYear}</div>
                                </div>
                            </label>
                        `;
                    }).join('');

                    usingSavedCard = true;
                    newCardSection.classList.add('hidden');
                }

                document.getElementById('add-new-card-btn').addEventListener('click', () => {
                    newCardSection.classList.remove('hidden');
                    document.getElementById('new-card-header').classList.remove('hidden');
                    usingSavedCard = false;
                    document.querySelectorAll('input[name="selected-card"]').forEach(input => input.checked = false);
                    document.querySelectorAll('.saved-card').forEach(cardEl => cardEl.classList.remove('selected'));
                });

                document.getElementById('cancel-new-card-btn').addEventListener('click', () => {
                    newCardSection.classList.add('hidden');
                    document.getElementById('new-card-header').classList.add('hidden');
                    const firstCard = document.querySelector('input[name="selected-card"]');
                    if (firstCard) {
                        firstCard.checked = true;
                        selectCard(firstCard.value);
                    }
                });

            } catch (err) {
                console.log('Error loading saved cards:', err);
                document.getElementById('new-card-section').classList.remove('hidden');
            }
        }

        function selectCard(paymentMethodId) {
            document.querySelectorAll('.saved-card').forEach(cardEl => cardEl.classList.remove('selected'));

            const selectedCardEl = document.querySelector(`.saved-card[data-pm-id="${paymentMethodId}"]`);
            if (selectedCardEl) selectedCardEl.classList.add('selected');

            const cardData = document.querySelector(`input[name="selected-card"][value="${paymentMethodId}"]`);
            if (cardData) {
                const cardElement = cardData.closest('.saved-card');
                const numberText = cardElement.querySelector('.card-number').textContent;
                const brand = numberText.split(' ')[0];
                const last4 = numberText.split('•••• ')[1];
                const expText = cardElement.querySelector('.card-expiry').textContent;
                const exp = expText.replace('Expires ', '').split('/');

                savedCard = {
                    paymentMethodId: paymentMethodId,
                    brand: brand.toLowerCase(),
                    last4: last4,
                    expMonth: parseInt(exp[0]),
                    expYear: parseInt(exp[1])
                };
                usingSavedCard = true;

                document.getElementById('new-card-section').classList.add('hidden');
                document.getElementById('new-card-header').classList.add('hidden');
            }
        }

        async function handlePayment() {
            const btn = document.getElementById('pay-btn');
            const payAmountEl = document.getElementById('pay-amount');
            
            // Store original button content for restoration
            const originalButtonHTML = btn.innerHTML;
            const originalAmount = payAmountEl ? payAmountEl.textContent : '0.00';
            
            btn.disabled = true;
            btn.classList.add('loading');
            btn.innerHTML = '<span class="btn-text">PROCESSING...</span>';

            try {
                // Validate we have the required data
                if (!paymentPayload) {
                    throw new Error('Payment not initialized. Please refresh the page.');
                }
                
                if (!stripe) {
                    throw new Error('Stripe not loaded. Please refresh the page.');
                }

                // Step 1: Create Payment Intent NOW (not on page load)
                btn.innerHTML = '<span class="btn-text">CREATING PAYMENT...</span>';
                
                const paymentRes = await fetch('/api/create-payment-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentPayload)
                });

                if (!paymentRes.ok) {
                    const error = await paymentRes.json();
                    
                    // Handle backer login required case
                    if (error.code === 'BACKER_LOGIN_REQUIRED') {
                        const confirmed = confirm(error.error + '\n\nWould you like to log in now?');
                        if (confirmed) {
                            sessionStorage.setItem('returnTo', '/payment');
                            window.location.href = '/login';
                            return;
                        } else {
                            window.location.href = '/checkout';
                            return;
                        }
                    }
                    
                    throw new Error(error.error || error.details || 'Failed to create payment');
                }

                const paymentData = await paymentRes.json();
                clientSecret = paymentData.clientSecret;
                paymentIntentId = paymentData.paymentIntentId;

                // Update display with server-calculated amounts (with null safety)
                if (paymentData.calculatedTotal !== undefined && paymentData.calculatedTotal !== null) {
                    const serverSubtotal = paymentData.calculatedSubtotal || 0;
                    const serverShipping = paymentData.calculatedShipping || 0;
                    const serverTotal = paymentData.calculatedTotal || 0;
                    
                    currentCartTotal = serverSubtotal;
                    currentShippingCost = serverShipping;

                    const subtotalEl = document.getElementById('subtotal');
                    const shippingEl = document.getElementById('shipping');
                    const totalEl = document.getElementById('total');
                    const payAmountEl = document.getElementById('pay-amount');
                    
                    if (subtotalEl) subtotalEl.textContent = '$' + serverSubtotal.toFixed(2);
                    if (shippingEl) shippingEl.textContent = '$' + serverShipping.toFixed(2);
                    if (totalEl) totalEl.textContent = '$' + serverTotal.toFixed(2);
                    if (payAmountEl) payAmountEl.textContent = serverTotal.toFixed(2);
                }

                console.log('✓ Payment Intent created:', paymentIntentId);

                // Step 2: Confirm the payment with Stripe
                btn.innerHTML = '<span class="btn-text">CONFIRMING PAYMENT...</span>';

                let confirmOptions;
                const saveCard = document.getElementById('save-card-checkbox')?.checked || false;
                const shippingAddr = JSON.parse(sessionStorage.getItem('shippingAddress') || '{}');

                if (usingSavedCard && savedCard) {
                    confirmOptions = { payment_method: savedCard.paymentMethodId };
                } else {
                    confirmOptions = {
                        payment_method: {
                            card: card,
                            billing_details: { email: shippingAddr.email }
                        },
                        setup_future_usage: saveCard ? 'off_session' : undefined
                    };
                }

                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, confirmOptions);

                if (error) throw new Error(error.message);

                btn.innerHTML = '<span class="btn-text">VERIFYING PAYMENT...</span>';

                // Step 3: Save payment method to database
                try {
                    await fetch('/api/save-payment-method', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            paymentIntentId: paymentIntent.id,
                            paymentMethodId: paymentIntent.payment_method
                        })
                    });
                } catch (saveErr) {
                    console.warn('Failed to save payment method:', saveErr);
                    // Continue even if save fails - payment is already confirmed
                }

                // Step 4: Verify payment status with Stripe
                const verified = await verifyPaymentWithStripe(paymentIntent.id);

                if (!verified.success) {
                    throw new Error(verified.message || 'Payment verification failed');
                }

                // Success! Clear cart and redirect
                App.Cart.clear();
                sessionStorage.removeItem('shippingAddress');
                sessionStorage.removeItem('shippingCost');

                // Store payment result for thank you page
                sessionStorage.setItem('paymentResult', JSON.stringify({
                    status: verified.status,
                    paid: verified.paid,
                    message: verified.message
                }));

                window.location.href = '/thankyou';

            } catch (err) {
                console.error('Payment error:', err);
                console.error('Error stack:', err.stack);
                alert('Payment failed: ' + err.message);
                
                // Restore button to original state (safely)
                const payBtn = document.getElementById('pay-btn');
                if (payBtn) {
                    payBtn.disabled = false;
                    payBtn.classList.remove('loading');
                    payBtn.innerHTML = '<span class="btn-text">PAY $<span id="pay-amount">' + originalAmount + '</span></span>';
                }
            }
        }

        // Verify payment with Stripe - polls until success, failure, or timeout
        async function verifyPaymentWithStripe(paymentIntentId, maxAttempts = 10, intervalMs = 2000) {
            console.log('Verifying payment with Stripe...');

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    const res = await fetch('/api/verify-payment-status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paymentIntentId })
                    });

                    if (!res.ok) {
                        const errorText = await res.text();
                        console.error('Verification API error:', res.status, errorText);
                        throw new Error('Verification failed: ' + res.status);
                    }

                    const result = await res.json();
                    console.log(`Verification attempt ${attempt}:`, result);

                    // Terminal states - stop polling
                    if (result.status === 'succeeded') {
                        return { success: true, ...result };
                    }
                    if (result.status === 'requires_capture') {
                        // Card saved for later charge - this is success for pre-auth
                        return { success: true, ...result };
                    }
                    if (result.status === 'canceled' || result.status === 'requires_payment_method') {
                        return { success: false, ...result };
                    }

                    // Non-terminal states - keep polling
                    if (attempt < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, intervalMs));
                    }

                } catch (err) {
                    console.error('Verification error:', err);
                    if (attempt === maxAttempts) {
                        return { success: false, status: 'error', message: err.message };
                    }
                    await new Promise(resolve => setTimeout(resolve, intervalMs));
                }
            }

            // Timeout - assume processing
            return {
                success: true,
                status: 'processing',
                message: 'Payment is being processed. You will receive confirmation shortly.'
            };
        }

        init();
    </script>
</body>

</html>