<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MAYA</title>
    <meta name="description" content="MAYA Admin Dashboard - Manage backers, orders, and products.">
    <meta name="theme-color" content="#0A0A0A">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/maya-logo.png">
    <link rel="apple-touch-icon" href="/images/maya-logo.png">
    
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .stat-grid {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        .stat-box {
            flex: 1;
            min-width: 150px;
            background: var(--matter);
            padding: 20px;
            border: 1px solid var(--border);
            text-align: center;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent);
            margin: 10px 0;
        }
        .stat-label {
            font-size: 10px;
            letter-spacing: 2px;
            color: var(--text-dim);
        }
        
        .tab-container {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            transition: all 0.3s;
            font-size: 11px;
            letter-spacing: 2px;
            color: var(--text-dim);
            background: transparent;
        }
        .tab:hover { 
            color: var(--text-main);
            background: var(--matter);
        }
        .tab.active {
            border-color: var(--border);
            border-bottom: 1px solid var(--void);
            background: var(--void);
            color: var(--accent);
            margin-bottom: -1px;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-bar input, .filter-bar select {
            padding: 10px 15px;
            background: var(--matter);
            border: 1px solid var(--border);
            color: white;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
        }
        .filter-bar input { 
            width: 300px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            text-align: left;
            padding: 15px;
            border-bottom: 2px solid var(--border);
            font-size: 10px;
            letter-spacing: 2px;
            color: var(--text-dim);
            white-space: nowrap;
        }
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
        }
        .data-table tbody tr { cursor: pointer; }
        .data-table tbody tr:hover { background: rgba(230, 30, 37, 0.08); }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 9px;
            letter-spacing: 1px;
            font-weight: 600;
            white-space: nowrap;
        }
        .badge-success { background: rgba(255, 255, 255, 0.1); color: var(--text-main); }
        .badge-warning { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .badge-neutral { background: rgba(100, 100, 100, 0.2); color: #999; }
        
        .action-btn {
            padding: 6px 12px;
            font-size: 10px;
            cursor: pointer;
            border: 1px solid var(--border);
            background: transparent;
            color: white;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .action-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }
        .action-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 60px 20px;
        }
        .modal-content {
            background: var(--void);
            border: 1px solid var(--border);
            padding: 30px;
            width: 100%;
            max-width: 600px;
        }
        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-dim);
            line-height: 1;
        }
        .close-modal:hover { color: var(--accent); }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 0;
        }
        .detail-label {
            padding: 10px 0;
            font-size: 10px;
            letter-spacing: 1px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
        }
        .detail-value {
            padding: 10px 0;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            border-bottom: 1px solid var(--border);
        }
        .detail-section {
            margin: 20px 0;
            padding-top: 10px;
            border-top: 2px solid var(--border);
            font-size: 10px;
            letter-spacing: 2px;
            color: var(--accent);
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .pagination {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            padding: 20px 0;
        }
        .pagination span {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="beta-tag">BETA v0.9</div>
    <div id="navbar">
        <a href="/admin/dashboard" class="logo-container"><img src="/images/maya-logo.png" alt="MAYA"></a>
        <div class="tech-decoration">/// COMMAND CENTER</div>
        <div class="flex items-center gap-4">
            <a href="/admin/control-panel" class="nav-btn">CONTROL PANEL</a>
            <a href="/admin/logout" class="nav-btn">LOGOUT</a>
        </div>
    </div>

    <div class="admin-container">
        <h1 style="margin-bottom: 40px; font-size: 24px; letter-spacing: 4px;">DASHBOARD</h1>

        <!-- Stats Row -->
        <div class="stat-grid">
            <div class="stat-box">
                <div class="stat-label">TOTAL BACKERS</div>
                <div class="stat-value" id="stat-total">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">WITH ORDERS</div>
                <div class="stat-value" id="stat-orders">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">CARDS SAVED</div>
                <div class="stat-value" id="stat-cards-saved" style="color: #3b82f6;">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">PAID</div>
                <div class="stat-value" id="stat-paid">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">PENDING</div>
                <div class="stat-value" id="stat-pending" style="color: #eab308;">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">REVENUE</div>
                <div class="stat-value" id="stat-revenue">-</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tab-container">
            <div class="tab active" data-tab="backers">ALL BACKERS</div>
            <div class="tab" data-tab="orders">ORDERS</div>
            <div class="tab" data-tab="pending">PENDING CHARGES</div>
            <div class="tab" data-tab="recent">RECENT ACTIVITY</div>
            <div class="tab" data-tab="logs">EMAIL LOGS</div>
        </div>

        <!-- BACKERS TAB -->
        <div id="tab-backers" class="tab-content active">
            <div class="filter-bar">
                <input type="text" id="search-backers" placeholder="Search by email or name...">
                <select id="filter-status">
                    <option value="">All Status</option>
                    <option value="collected">Collected</option>
                    <option value="dropped">Dropped</option>
                    <option value="canceled">Canceled</option>
                </select>
                <select id="filter-order">
                    <option value="">All</option>
                    <option value="true">With Order</option>
                    <option value="false">No Order</option>
                </select>
                <button class="action-btn" onclick="loadBackers()">SEARCH</button>
                <button class="action-btn" onclick="clearFilters()">CLEAR</button>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>EMAIL</th>
                            <th>NAME</th>
                            <th>BACKER #</th>
                            <th>KS STATUS</th>
                            <th>COUNTRY</th>
                            <th>ORDER</th>
                            <th>PAYMENT</th>
                        </tr>
                    </thead>
                    <tbody id="backers-tbody"></tbody>
                </table>
            </div>
            <div class="pagination" id="backers-pagination"></div>
        </div>

        <!-- ORDERS TAB -->
        <div id="tab-orders" class="tab-content">
            <div class="filter-bar">
                <button class="action-btn primary" onclick="bulkVerifyPayments()">VERIFY ALL WITH STRIPE</button>
                <button class="action-btn" onclick="exportOrders()">EXPORT CSV</button>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ORDER ID</th>
                            <th>EMAIL</th>
                            <th>NAME</th>
                            <th>TOTAL</th>
                            <th>STATUS</th>
                            <th>DATE</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- PENDING TAB -->
        <div id="tab-pending" class="tab-content">
            <div class="filter-bar">
                <button class="action-btn primary" onclick="bulkChargeOrders()">BULK CHARGE ALL</button>
                <button class="action-btn" onclick="bulkVerifyPayments()">VERIFY ALL WITH STRIPE</button>
                <button class="action-btn" onclick="syncCardDetails()">SYNC CARD DETAILS</button>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>EMAIL</th>
                            <th>NAME</th>
                            <th>TOTAL</th>
                            <th>CARD</th>
                            <th>STATUS</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="pending-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- RECENT ACTIVITY TAB -->
        <div id="tab-recent" class="tab-content">
            <div class="filter-bar">
                <select id="recent-filter">
                    <option value="all">All Activity</option>
                    <option value="orders">Orders</option>
                    <option value="payments">Payments</option>
                    <option value="cards">Card Saves</option>
                </select>
                <button class="action-btn" onclick="loadRecentActivity()">REFRESH</button>
                <button class="action-btn" onclick="exportSelectedRecent()">EXPORT SELECTED</button>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="select-all-recent" onchange="toggleSelectAllRecent()"></th>
                            <th style="width: 50px;">#</th>
                            <th>TIME</th>
                            <th>EMAIL</th>
                            <th>TYPE</th>
                            <th>DETAILS</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="recent-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- LOGS TAB -->
        <div id="tab-logs" class="tab-content">
            <div class="filter-bar">
                <select id="log-type-filter">
                    <option value="">All Types</option>
                    <option value="magic_link">Magic Links</option>
                    <option value="card_saved">Card Saved</option>
                    <option value="order_confirmation">Order Confirmation</option>
                    <option value="payment_receipt">Payment Receipt</option>
                </select>
                <button class="action-btn" onclick="loadLogs()">REFRESH</button>
                <button class="action-btn" onclick="exportSelectedLogs()">EXPORT SELECTED</button>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="select-all-logs" onchange="toggleSelectAllLogs()"></th>
                            <th style="width: 50px;">#</th>
                            <th>TIME</th>
                            <th>EMAIL</th>
                            <th>TYPE</th>
                            <th>SUBJECT</th>
                            <th>STATUS</th>
                        </tr>
                    </thead>
                    <tbody id="logs-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 style="margin: 0 0 25px 0; font-size: 16px; letter-spacing: 3px;">BACKER PROFILE</h2>
            <div id="user-detail-content"></div>
            <div class="modal-actions" id="modal-actions"></div>
        </div>
    </div>

    <script>
        let currentPage = 0;
        const pageSize = 50;
        let searchTimeout;
        let selectedUser = null;
        let allBackersCache = [];

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById('tab-' + this.dataset.tab).classList.add('active');
                
                const tabName = this.dataset.tab;
                if (tabName === 'backers') loadBackers();
                else if (tabName === 'orders') loadOrders();
                else if (tabName === 'pending') loadPending();
                else if (tabName === 'recent') loadRecentActivity();
                else if (tabName === 'logs') loadLogs();
            });
        });

        // Search debounce
        document.getElementById('search-backers').addEventListener('keyup', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 0;
                loadBackers();
            }, 300);
        });

        document.getElementById('filter-status').addEventListener('change', () => { currentPage = 0; loadBackers(); });
        document.getElementById('filter-order').addEventListener('change', () => { currentPage = 0; loadBackers(); });

        function clearFilters() {
            document.getElementById('search-backers').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-order').value = '';
            currentPage = 0;
            loadBackers();
        }

        // Load stats
        async function loadStats() {
            try {
                const [statsRes, backersRes] = await Promise.all([
                    fetch('/api/admin/stats'),
                    fetch('/api/admin/backers?limit=500')
                ]);
                const stats = await statsRes.json();
                const backersData = await backersRes.json();
                
                // Count cards saved
                const cardsSaved = (backersData.backers || []).filter(b => 
                    b.stripe_payment_method && (b.pm_status === 'card_saved' || b.pm_status === 'pending')
                ).length;
                
                document.getElementById('stat-total').textContent = (backersData.total || 0).toLocaleString();
                document.getElementById('stat-orders').textContent = ((stats.completedOrders || 0) + (stats.pendingOrders || 0));
                document.getElementById('stat-cards-saved').textContent = cardsSaved;
                document.getElementById('stat-paid').textContent = stats.completedOrders || 0;
                document.getElementById('stat-pending').textContent = stats.pendingOrders || 0;
                document.getElementById('stat-revenue').textContent = '$' + (stats.totalRevenue || 0).toLocaleString();
            } catch (e) {
                console.error('Error loading stats:', e);
            }
        }

        // Load backers
        async function loadBackers() {
            const tbody = document.getElementById('backers-tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-dim);">Loading...</td></tr>';
            
            try {
                const search = document.getElementById('search-backers').value;
                const status = document.getElementById('filter-status').value;
                const hasOrder = document.getElementById('filter-order').value;
                
                let url = `/api/admin/backers?limit=${pageSize}&offset=${currentPage * pageSize}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (status) url += `&status=${status}`;
                if (hasOrder) url += `&hasOrder=${hasOrder}`;
                
                const res = await fetch(url);
                const data = await res.json();
                allBackersCache = data.backers;
                
                if (!data.backers || data.backers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-dim);">No backers found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.backers.map((b, idx) => `
                    <tr data-index="${idx}">
                        <td>${b.email || '-'}</td>
                        <td>${b.name || '-'}</td>
                        <td>${b.ks_backer_number || '-'}</td>
                        <td>${getStatusBadge(b.ks_status)}</td>
                        <td>${b.ks_country || '-'}</td>
                        <td>${b.pm_total ? '$' + b.pm_total : '-'}</td>
                        <td>${getPaymentBadge(b)}</td>
                    </tr>
                `).join('');
                
                // Add click handlers
                tbody.querySelectorAll('tr').forEach(row => {
                    row.addEventListener('click', function() {
                        const idx = parseInt(this.dataset.index);
                        openUserModal(allBackersCache[idx]);
                    });
                });
                
                renderPagination(data.total);
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--accent);">Error loading data</td></tr>';
            }
        }

        // Load orders
        async function loadOrders() {
            const tbody = document.getElementById('orders-tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-dim);">Loading...</td></tr>';
            
            try {
                const res = await fetch('/api/admin/orders');
                const orders = await res.json();
                
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-dim);">No orders</td></tr>';
                    return;
                }
                
                tbody.innerHTML = orders.map(o => `
                    <tr data-id="${o.identity_id}">
                        <td>#${o.pm_order_id || (o.id ? o.id.substring(0,8) : '-')}</td>
                        <td>${o.email || '-'}</td>
                        <td>${o.backer_name || 'Guest'}</td>
                        <td>$${o.total || 0}</td>
                        <td>${getPaymentBadgeFromStatus(o.payment_status, o.paid)}</td>
                        <td>${formatDate(o.created_at)}</td>
                        <td>
                            <button class="action-btn" onclick="event.stopPropagation(); verifyPayment('${o.identity_id}')">VERIFY</button>
                            ${!o.paid ? `<button class="action-btn primary" onclick="event.stopPropagation(); chargeOrder('${o.identity_id}')">CHARGE</button>` : ''}
                        </td>
                    </tr>
                `).join('');
                
                // Click to open modal
                tbody.querySelectorAll('tr').forEach(row => {
                    row.addEventListener('click', async function() {
                        const id = this.dataset.id;
                        const res = await fetch(`/api/admin/backers?search=${id}&limit=1`);
                        const data = await res.json();
                        if (data.backers && data.backers[0]) openUserModal(data.backers[0]);
                    });
                });
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--accent);">Error</td></tr>';
            }
        }

        // Load pending
        async function loadPending() {
            const tbody = document.getElementById('pending-tbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-dim);">Loading...</td></tr>';
            
            try {
                const res = await fetch('/api/admin/backers?limit=500');
                const data = await res.json();
                const pending = data.backers.filter(b => 
                    b.stripe_payment_intent && (b.pm_status === 'pending' || b.pm_status === 'card_saved' || b.pm_paid === 0 || b.pm_paid === '0')
                );
                
                if (pending.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-dim);">No pending charges</td></tr>';
                    return;
                }
                
                tbody.innerHTML = pending.map((b, idx) => `
                    <tr data-backer='${JSON.stringify(b).replace(/'/g, "\\'")}'>
                        <td>${b.email}</td>
                        <td>${b.name || '-'}</td>
                        <td>$${b.pm_total || 0}</td>
                        <td>${getCardBadge(b)}</td>
                        <td>${getPaymentBadge(b)}</td>
                        <td>
                            <button class="action-btn" onclick="event.stopPropagation(); verifyPayment('${b.identity_id}')">VERIFY</button>
                            <button class="action-btn primary" onclick="event.stopPropagation(); chargeOrder('${b.identity_id}')">CHARGE</button>
                        </td>
                    </tr>
                `).join('');
                
                tbody.querySelectorAll('tr').forEach(row => {
                    row.addEventListener('click', function() {
                        const b = JSON.parse(this.dataset.backer);
                        openUserModal(b);
                    });
                });
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--accent);">Error</td></tr>';
            }
        }

        // Sync card details from Stripe
        async function syncCardDetails() {
            if (!confirm('Sync card details from Stripe for all users? This may take a few minutes.')) return;
            
            try {
                const res = await fetch('/api/admin/sync-card-details', { method: 'POST' });
                const result = await res.json();
                
                alert(`Card Sync Complete!\n\nTotal checked: ${result.total}\nUpdated: ${result.updated}\nAlready had details: ${result.alreadyHaveDetails}\nNo payment method: ${result.noPaymentMethod}\nErrors: ${result.errors?.length || 0}`);
                
                refreshCurrentTab();
            } catch (e) {
                alert('Error syncing: ' + e.message);
            }
        }

        // Format time with relative info
        function formatTimeAgo(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return `${diff}s ago`;
            if (diff < 3600) return `${Math.floor(diff/60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff/3600)}h ago`;
            if (diff < 604800) return `${Math.floor(diff/86400)}d ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        function formatFullTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        let logsData = [];
        let recentData = [];

        // Load logs with checkboxes and serial numbers
        async function loadLogs() {
            const tbody = document.getElementById('logs-tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-dim);">Loading...</td></tr>';
            
            try {
                const typeFilter = document.getElementById('log-type-filter').value;
                let url = '/api/admin/email-logs';
                if (typeFilter) url += `?type=${typeFilter}`;
                
                const res = await fetch(url);
                const data = await res.json();
                logsData = data.logs || [];
                
                if (logsData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-dim);">No logs</td></tr>';
                    return;
                }
                
                tbody.innerHTML = logsData.map((l, idx) => `
                    <tr data-idx="${idx}">
                        <td><input type="checkbox" class="log-checkbox" data-idx="${idx}"></td>
                        <td style="color: var(--text-dim);">${idx + 1}</td>
                        <td title="${formatFullTime(l.sent_at)}">${formatTimeAgo(l.sent_at)}</td>
                        <td>${l.email || '-'}</td>
                        <td><span class="badge badge-info">${(l.email_type || '-').toUpperCase().replace(/_/g, ' ')}</span></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${l.subject || '-'}</td>
                        <td><span class="badge ${l.status === 'sent' ? 'badge-success' : 'badge-danger'}">${(l.status || 'unknown').toUpperCase()}</span></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--accent);">Error loading logs</td></tr>';
            }
        }
        
        // Load recent activity
        async function loadRecentActivity() {
            const tbody = document.getElementById('recent-tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-dim);">Loading...</td></tr>';
            
            try {
                const filter = document.getElementById('recent-filter').value;
                const backersRes = await fetch('/api/admin/backers?limit=100');
                const backersData = await backersRes.json();
                
                // Build activity list from backers
                let activities = [];
                
                (backersData.backers || []).forEach(b => {
                    // Card saved activity
                    if (b.stripe_payment_method && b.pm_created_at) {
                        activities.push({
                            time: b.pm_created_at,
                            email: b.email,
                            type: 'card_saved',
                            details: b.stripe_card_brand ? `${b.stripe_card_brand} ****${b.stripe_card_last4}` : 'Card saved',
                            status: b.pm_status
                        });
                    }
                    
                    // Order activity
                    if (b.pm_total && b.pm_created_at) {
                        activities.push({
                            time: b.pm_created_at,
                            email: b.email,
                            type: 'order',
                            details: `$${b.pm_total} order`,
                            status: b.pm_paid ? 'paid' : 'pending'
                        });
                    }
                    
                    // Payment activity
                    if (b.pm_paid && b.pm_status === 'succeeded') {
                        activities.push({
                            time: b.updated_at || b.pm_created_at,
                            email: b.email,
                            type: 'payment',
                            details: `$${b.pm_total} charged`,
                            status: 'succeeded'
                        });
                    }
                });
                
                // Filter by type
                if (filter !== 'all') {
                    if (filter === 'cards') {
                        activities = activities.filter(a => a.type === 'card_saved');
                    } else if (filter === 'orders') {
                        activities = activities.filter(a => a.type === 'order');
                    } else if (filter === 'payments') {
                        activities = activities.filter(a => a.type === 'payment');
                    }
                }
                
                // Sort by time descending
                activities.sort((a, b) => new Date(b.time) - new Date(a.time));
                
                // Limit to 100 recent
                recentData = activities.slice(0, 100);
                
                if (recentData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-dim);">No recent activity</td></tr>';
                    return;
                }
                
                tbody.innerHTML = recentData.map((a, idx) => `
                    <tr data-idx="${idx}">
                        <td><input type="checkbox" class="recent-checkbox" data-idx="${idx}"></td>
                        <td style="color: var(--text-dim);">${idx + 1}</td>
                        <td title="${formatFullTime(a.time)}">${formatTimeAgo(a.time)}</td>
                        <td>${a.email || '-'}</td>
                        <td><span class="badge ${a.type === 'payment' ? 'badge-success' : a.type === 'card_saved' ? 'badge-info' : 'badge-warning'}">${a.type.toUpperCase().replace(/_/g, ' ')}</span></td>
                        <td>${a.details || '-'}</td>
                        <td><span class="badge ${a.status === 'succeeded' || a.status === 'paid' ? 'badge-success' : a.status === 'card_saved' ? 'badge-info' : 'badge-warning'}">${(a.status || '-').toUpperCase()}</span></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--accent);">Error loading activity</td></tr>';
            }
        }
        
        // Toggle select all
        function toggleSelectAllLogs() {
            const checked = document.getElementById('select-all-logs').checked;
            document.querySelectorAll('.log-checkbox').forEach(cb => cb.checked = checked);
        }
        
        function toggleSelectAllRecent() {
            const checked = document.getElementById('select-all-recent').checked;
            document.querySelectorAll('.recent-checkbox').forEach(cb => cb.checked = checked);
        }
        
        // Export selected logs
        function exportSelectedLogs() {
            const selected = [];
            document.querySelectorAll('.log-checkbox:checked').forEach(cb => {
                selected.push(logsData[parseInt(cb.dataset.idx)]);
            });
            
            if (selected.length === 0) {
                alert('Please select rows to export');
                return;
            }
            
            // Build CSV
            let csv = 'Serial,Time,Email,Type,Subject,Status\n';
            selected.forEach((l, idx) => {
                csv += `${idx + 1},"${formatFullTime(l.sent_at)}","${l.email || ''}","${l.email_type || ''}","${(l.subject || '').replace(/"/g, '""')}","${l.status || ''}"\n`;
            });
            
            downloadCSV(csv, 'email-logs-export.csv');
        }
        
        function exportSelectedRecent() {
            const selected = [];
            document.querySelectorAll('.recent-checkbox:checked').forEach(cb => {
                selected.push(recentData[parseInt(cb.dataset.idx)]);
            });
            
            if (selected.length === 0) {
                alert('Please select rows to export');
                return;
            }
            
            let csv = 'Serial,Time,Email,Type,Details,Status\n';
            selected.forEach((a, idx) => {
                csv += `${idx + 1},"${formatFullTime(a.time)}","${a.email || ''}","${a.type || ''}","${(a.details || '').replace(/"/g, '""')}","${a.status || ''}"\n`;
            });
            
            downloadCSV(csv, 'recent-activity-export.csv');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Open user modal with FULL profile data
        function openUserModal(user) {
            if (!user) return;
            selectedUser = user;
            
            const content = document.getElementById('user-detail-content');
            content.innerHTML = `
                <div class="detail-section">IDENTITY</div>
                <div class="detail-grid">
                    <div class="detail-label">EMAIL</div>
                    <div class="detail-value">${user.email || '-'}</div>
                    <div class="detail-label">NAME</div>
                    <div class="detail-value">${user.name || '-'}</div>
                    <div class="detail-label">IDENTITY ID</div>
                    <div class="detail-value" style="font-size: 10px;">${user.identity_id || '-'}</div>
                </div>
                
                <div class="detail-section">KICKSTARTER</div>
                <div class="detail-grid">
                    <div class="detail-label">BACKER #</div>
                    <div class="detail-value">${user.ks_backer_number || '-'}</div>
                    <div class="detail-label">STATUS</div>
                    <div class="detail-value">${getStatusBadge(user.ks_status)}</div>
                    <div class="detail-label">POT</div>
                    <div class="detail-value">${user.ks_pledge_over_time ? 'Yes' : 'No'}</div>
                    <div class="detail-label">COUNTRY</div>
                    <div class="detail-value">${user.ks_country || '-'}</div>
                    <div class="detail-label">PLEDGE AMOUNT</div>
                    <div class="detail-value">$${user.ks_pledge_amount || 0}</div>
                    <div class="detail-label">AMOUNT PAID</div>
                    <div class="detail-value">$${user.ks_amount_paid || 0}</div>
                </div>
                
                <div class="detail-section">ORDER</div>
                <div class="detail-grid">
                    <div class="detail-label">ORDER TOTAL</div>
                    <div class="detail-value">$${user.pm_total || 0}</div>
                    <div class="detail-label">PAYMENT</div>
                    <div class="detail-value">${getPaymentBadge(user)}</div>
                    <div class="detail-label">PM STATUS</div>
                    <div class="detail-value">${user.pm_status || '-'}</div>
                </div>
                
                <div class="detail-section">STRIPE & CARD</div>
                <div class="detail-grid">
                    <div class="detail-label">CARD</div>
                    <div class="detail-value">${getCardDisplay(user)}</div>
                    <div class="detail-label">CUSTOMER ID</div>
                    <div class="detail-value" style="font-size: 10px; word-break: break-all;">${user.stripe_customer_id || '-'}</div>
                    <div class="detail-label">PAYMENT INTENT</div>
                    <div class="detail-value" style="font-size: 10px; word-break: break-all;">${user.stripe_payment_intent || '-'}</div>
                    <div class="detail-label">PAYMENT METHOD</div>
                    <div class="detail-value" style="font-size: 10px; word-break: break-all;">${user.stripe_payment_method || '-'}</div>
                </div>
                
                <div class="detail-section">SHIPPING</div>
                <div class="detail-grid">
                    <div class="detail-label">COUNTRY</div>
                    <div class="detail-value">${user.ship_country || '-'}</div>
                    <div class="detail-label">VERIFIED</div>
                    <div class="detail-value">${user.ship_verified ? '<span class="badge badge-success">YES</span>' : '<span class="badge badge-neutral">NO</span>'}</div>
                    <div class="detail-label">LOCKED</div>
                    <div class="detail-value">${user.ship_locked ? '<span class="badge badge-warning">LOCKED</span>' : '<span class="badge badge-neutral">NO</span>'}</div>
                </div>
            `;
            
            // Actions
            const actions = document.getElementById('modal-actions');
            let actionsHtml = '';
            
            if (user.stripe_payment_intent) {
                actionsHtml += `<button class="action-btn" onclick="verifyUserPayment()">VERIFY WITH STRIPE</button>`;
            }
            if (user.stripe_payment_intent && (user.pm_paid === 0 || user.pm_paid === '0' || !user.pm_paid)) {
                actionsHtml += `<button class="action-btn primary" onclick="chargeUserOrder()">CHARGE NOW</button>`;
            }
            
            actions.innerHTML = actionsHtml || '<span style="color: var(--text-dim); font-size: 11px;">No actions available</span>';
            
            document.getElementById('user-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('user-modal').classList.remove('active');
            selectedUser = null;
        }

        // Close modal on outside click
        document.getElementById('user-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        async function verifyUserPayment() {
            if (!selectedUser) return;
            await verifyPayment(selectedUser.identity_id);
        }

        async function chargeUserOrder() {
            if (!selectedUser) return;
            await chargeOrder(selectedUser.identity_id);
        }

        // Payment actions
        async function verifyPayment(identityId) {
            try {
                const res = await fetch(`/api/admin/verify-payment/${identityId}`, { method: 'POST' });
                const result = await res.json();
                
                if (result.success) {
                    alert(`Payment Verified!\n\nStripe Status: ${result.stripeStatus}\nPrevious: ${result.previousStatus}\nNew: ${result.newStatus}\nAmount: $${result.amount}`);
                    loadStats();
                    refreshCurrentTab();
                    closeModal();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error verifying payment: ' + e.message);
            }
        }

        async function chargeOrder(identityId) {
            if (!confirm('Charge this order now?')) return;
            
            try {
                const res = await fetch(`/api/admin/charge-order/${identityId}`, { method: 'POST' });
                const result = await res.json();
                
                if (result.success) {
                    alert(`Payment charged!\n${result.message || ''}`);
                    loadStats();
                    refreshCurrentTab();
                    closeModal();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error charging: ' + e.message);
            }
        }

        async function bulkChargeOrders() {
            if (!confirm('Charge ALL orders with saved cards?')) return;
            
            try {
                const res = await fetch('/api/admin/bulk-charge-orders', { method: 'POST' });
                const result = await res.json();
                alert(`Bulk Charge Complete!\n\nTotal: ${result.total || 0}\nCharged: ${result.charged || 0}\nFailed: ${result.failed || 0}`);
                loadStats();
                loadPending();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function bulkVerifyPayments() {
            if (!confirm('Verify all pending payments with Stripe?')) return;
            
            try {
                const res = await fetch('/api/admin/bulk-verify-payments', { method: 'POST' });
                const result = await res.json();
                alert(`Verification Complete!\n\nTotal: ${result.total}\nUpdated: ${result.updated}\nSucceeded: ${result.succeeded}\nFailed: ${result.failed}`);
                loadStats();
                refreshCurrentTab();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function refreshCurrentTab() {
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabName = activeTab.dataset.tab;
                if (tabName === 'backers') loadBackers();
                else if (tabName === 'orders') loadOrders();
                else if (tabName === 'pending') loadPending();
                else if (tabName === 'logs') loadLogs();
            }
        }

        // Helpers
        function getStatusBadge(status) {
            if (status === 'collected') return '<span class="badge badge-success">COLLECTED</span>';
            if (status === 'dropped') return '<span class="badge badge-warning">DROPPED</span>';
            if (status === 'canceled') return '<span class="badge badge-danger">CANCELED</span>';
            return '<span class="badge badge-neutral">' + (status ? status.toUpperCase() : '-') + '</span>';
        }

        function getCardBadge(b) {
            if (b.stripe_card_last4) {
                const brand = (b.stripe_card_brand || 'card').charAt(0).toUpperCase() + (b.stripe_card_brand || 'card').slice(1);
                return `<span class="badge badge-info">${brand} •••• ${b.stripe_card_last4}</span>`;
            }
            if (b.stripe_payment_method || b.stripe_customer_id) {
                return '<span class="badge badge-warning">CARD (fetch)</span>';
            }
            return '-';
        }

        function getCardDisplay(user) {
            if (user.stripe_card_last4) {
                const brand = (user.stripe_card_brand || 'Card').charAt(0).toUpperCase() + (user.stripe_card_brand || 'card').slice(1);
                const exp = user.stripe_card_exp || '';
                return `<span class="badge badge-info">${brand} •••• ${user.stripe_card_last4}</span> ${exp ? `<span style="color: var(--text-dim); font-size: 10px;">exp ${exp}</span>` : ''}`;
            }
            if (user.stripe_payment_method || user.stripe_customer_id) {
                return '<span class="badge badge-warning">Card on file (details not synced)</span>';
            }
            return '<span style="color: var(--text-dim);">No card on file</span>';
        }

        function getPaymentBadge(b) {
            if (!b.pm_total && !b.stripe_payment_intent) return '-';
            if (b.pm_paid === 1 || b.pm_paid === '1' || b.pm_status === 'succeeded') {
                return '<span class="badge badge-success">PAID</span>';
            }
            if (b.pm_status === 'card_saved') {
                return '<span class="badge badge-warning">CARD SAVED</span>';
            }
            if (b.pm_status === 'failed') {
                return '<span class="badge badge-danger">FAILED</span>';
            }
            if (b.pm_status === 'pending') {
                return '<span class="badge badge-info">PENDING</span>';
            }
            return '<span class="badge badge-neutral">' + (b.pm_status ? b.pm_status.toUpperCase() : 'UNKNOWN') + '</span>';
        }

        function getPaymentBadgeFromStatus(status, paid) {
            if (paid === 1 || paid === '1' || status === 'succeeded') {
                return '<span class="badge badge-success">PAID</span>';
            }
            if (status === 'card_saved') {
                return '<span class="badge badge-warning">CARD SAVED</span>';
            }
            if (status === 'failed') {
                return '<span class="badge badge-danger">FAILED</span>';
            }
            return '<span class="badge badge-info">' + (status ? status.toUpperCase() : 'PENDING') + '</span>';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function renderPagination(total) {
            const totalPages = Math.ceil(total / pageSize);
            const container = document.getElementById('backers-pagination');
            
            if (totalPages <= 1) {
                container.innerHTML = `<span>${total} results</span>`;
                return;
            }
            
            let html = '';
            if (currentPage > 0) {
                html += `<button class="action-btn" onclick="goToPage(${currentPage - 1})">PREV</button>`;
            }
            html += `<span>Page ${currentPage + 1} of ${totalPages} (${total} total)</span>`;
            if (currentPage < totalPages - 1) {
                html += `<button class="action-btn" onclick="goToPage(${currentPage + 1})">NEXT</button>`;
            }
            container.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadBackers();
        }

        function exportOrders() {
            window.location.href = '/api/admin/export/orders';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadBackers();
        });
    </script>
</body>
</html>
