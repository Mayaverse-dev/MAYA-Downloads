<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Confirmed - MAYA Pledge Manager</title>
    <meta name="description" content="Thank you for your MAYA order! Your pledge has been confirmed.">
    <meta name="theme-color" content="#0A0A0A">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://store.entermaya.com/thankyou">
    <meta property="og:title" content="Order Confirmed - MAYA">
    <meta property="og:description" content="Thank you for your MAYA order! Your pledge has been confirmed.">
    <meta property="og:image" content="https://store.entermaya.com/images/hero/divya.png">
    <meta property="og:site_name" content="MAYA Store">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Order Confirmed - MAYA">
    <meta name="twitter:image" content="https://store.entermaya.com/images/hero/divya.png">
    <meta name="twitter:site" content="@maya_lore_">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/images/maya-logo.png">
    <link rel="apple-touch-icon" href="/images/maya-logo.png">
    
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/app.js"></script>
</head>

<body>
    <div class="beta-tag">BETA v0.9</div>
    <div id="navbar">
        <a href="/" class="logo-container">
            <img src="/images/maya-logo.png" alt="MAYA">
        </a>
        <div class="tech-decoration hidden" style="display: none; md:display: block;">
            /// ORDER STATUS
        </div>
        <div class="flex items-center gap-4">
            <a href="/" class="nav-btn">STORE</a>
        </div>
    </div>

    <div class="container" style="min-height: 80vh; padding-top: 40px; padding-bottom: 40px;">
        <!-- Order Summary Card -->
        <div class="col-span-12 md:col-start-2 md:col-span-10">
            <div class="card artifact-frame p-60" style="max-width: 800px; margin: 0 auto;">

                <!-- Order Confirmed Header -->
                <div class="text-center mb-40">
                    <div class="success-checkmark mb-20" style="width: 64px; height: 64px; margin: 0 auto; border-radius: 50%; background: var(--success); display: flex; align-items: center; justify-content: center; animation: checkmarkPulse 0.6s var(--ease-spring);">
                        <svg style="width: 32px; height: 32px; color: white; stroke-width: 3;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <div class="tech-decoration mb-20" style="font-size: 11px; opacity: 0.8;">/// STATUS: CONFIRMED</div>
                    <h1 class="text-red mb-10" style="font-size: 2.5rem;">ORDER CONFIRMED</h1>
                    <p class="font-mono text-dim mb-2" style="font-size: 10px; letter-spacing: 0.15em; margin-top: var(--space-5);">
                        ORDER ID: <span id="order-id" class="text-white font-mono" style="cursor: pointer; user-select: all;" onclick="navigator.clipboard.writeText(this.textContent); this.style.opacity='0.6'; setTimeout(() => this.style.opacity='1', 200);">Loading...</span>
                    </p>
                    <p class="font-mono text-dim" style="font-size: 10px; letter-spacing: 0.15em;">
                        DATE: <span id="order-date" class="text-white">Loading...</span>
                    </p>
                </div>

                <!-- Divider -->
                <div style="height: 1px; background: var(--border); margin: 24px 0;"></div>

                <!-- Order Items -->
                <div class="mb-40">
                    <h2 class="mb-20 font-mono text-sm tracking-widest text-dim">ITEMS</h2>
                    <div id="order-items-list" class="mb-20">
                        <!-- Items populated by JS -->
                    </div>
                    <div style="border-top: 1px dashed var(--border); padding-top: var(--space-5); margin-top: var(--space-5);">
                        <div class="flex justify-between mb-10 font-mono" style="font-size: 11px; color: var(--text-dim);">
                            <span>SUBTOTAL</span>
                            <span id="order-subtotal" class="text-white">$0.00</span>
                        </div>
                        <div class="flex justify-between mb-10 font-mono" style="font-size: 11px; color: var(--text-dim);">
                            <span>SHIPPING</span>
                            <span id="order-shipping" class="text-white">$0.00</span>
                        </div>
                        <div class="flex justify-between mt-20 items-end" style="border-top: 1px dashed var(--border); padding-top: var(--space-5);">
                            <span class="stat-label">TOTAL CHARGED</span>
                            <span id="order-total" style="font-family: 'Inter', sans-serif; font-size: 1.75rem; font-weight: 500; color: var(--text-main);">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="mb-40">
                    <h2 class="mb-20 font-mono text-sm tracking-widest text-dim">SHIPPING TO</h2>
                    <div id="order-shipping-address" style="font-family: 'Inter', sans-serif; font-size: 14px; color: var(--text-main); line-height: 1.8;">
                        <!-- Address populated by JS -->
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="mb-40">
                    <h2 class="mb-20 font-mono text-sm tracking-widest text-dim">PAYMENT</h2>
                    <div id="order-payment-method" style="font-family: 'Inter', sans-serif; font-size: 14px; color: var(--text-main); display: flex; align-items: center; gap: var(--space-3);">
                        <!-- Payment method populated by JS -->
                    </div>
                </div>

                <!-- Divider -->
                <div style="height: 1px; background: var(--border); margin: 40px 0;"></div>

                <!-- Continue Journey Section -->
                <div id="next-steps-section" class="text-center">
                    <h2 class="mb-20 font-mono text-sm tracking-widest text-dim">WHAT'S NEXT?</h2>
                    <p class="text-white mb-8" style="font-size: 1rem; font-weight: 500; font-family: 'Inter', sans-serif;">Thank you for being part of the MAYA universe.</p>
                    
                    <!-- Two Options -->
                    <div id="initial-options" class="flex flex-col" style="gap: var(--space-4); margin-top: var(--space-6);">
                        <!-- Option 1: Create PIN -->
                        <div class="card p-20" style="border: 1px solid var(--border); cursor: pointer; transition: all var(--duration-normal) var(--ease-out);" 
                             onclick="showPinSetup()" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                            <div class="flex items-center gap-4">
                                <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(230, 30, 37, 0.1); display: flex; align-items: center; justify-content: center;">
                                    <svg style="width: 24px; height: 24px; color: var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="text-white font-inter mb-1" style="font-weight: 500;">Create PIN for Easy Login</div>
                                    <div class="font-mono text-dim" style="font-size: 11px;">Quick 4-digit PIN for future access</div>
                                </div>
                                <svg style="width: 20px; height: 20px; color: var(--text-dim);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Option 2: Join Discord -->
                        <a href="https://discord.gg/7HwhQaN6" target="_blank" class="card p-20" style="border: 1px solid var(--border); cursor: pointer; transition: all var(--duration-normal) var(--ease-out); text-decoration: none;" 
                             onmouseover="this.style.borderColor='#5865F2'" onmouseout="this.style.borderColor='var(--border)'">
                            <div class="flex items-center gap-4">
                                <div style="width: 48px; height: 48px; border-radius: 12px; background: rgba(88, 101, 242, 0.1); display: flex; align-items: center; justify-content: center;">
                                    <svg style="width: 24px; height: 24px; color: #5865F2;" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/>
                                    </svg>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="text-white font-inter mb-1" style="font-weight: 500;">Join Discord Community</div>
                                    <div class="font-mono text-dim" style="font-size: 11px;">8,000+ backers • Exclusive updates • World building</div>
                                </div>
                                <svg style="width: 20px; height: 20px; color: var(--text-dim);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </div>
                        </a>
                    </div>
                    
                    <!-- PIN Setup Flow (Hidden initially) -->
                    <div id="pin-setup-section" class="hidden" style="margin-top: var(--space-6);">
                        <!-- Step 1: Get OTP -->
                        <div id="otp-step">
                            <p class="font-mono text-dim mb-20" style="font-size: 13px;">We'll send a code to <span id="user-email" class="text-white">your email</span></p>
                            <button onclick="sendOtp()" id="send-otp-btn" class="btn btn-primary w-full mb-20">
                                SEND VERIFICATION CODE
                            </button>
                        </div>
                        
                        <!-- Step 2: Enter OTP -->
                        <div id="verify-otp-step" class="hidden">
                            <p class="font-mono text-dim mb-20" style="font-size: 13px;">Enter the 4-digit code sent to your email</p>
                            <input type="text" id="otp-input" class="form-input text-center mb-20" 
                                   placeholder="0000" maxlength="4" inputmode="numeric" 
                                   style="width: 160px; margin: 0 auto; font-size: 28px; letter-spacing: 0.4em; display: block;">
                            <button onclick="verifyOtp()" id="verify-otp-btn" class="btn btn-primary w-full">
                                VERIFY CODE
                            </button>
                        </div>
                        
                        <!-- Step 3: Set PIN -->
                        <div id="set-pin-step" class="hidden">
                            <p class="font-mono text-dim mb-20" style="font-size: 13px;">Create your 4-digit PIN</p>
                            <div class="flex justify-center mb-20" style="gap: var(--space-3);">
                                <input type="password" class="form-input text-center pin-input" maxlength="1" inputmode="numeric" style="width: 56px; height: 56px; font-size: 28px; padding: 0;">
                                <input type="password" class="form-input text-center pin-input" maxlength="1" inputmode="numeric" style="width: 56px; height: 56px; font-size: 28px; padding: 0;">
                                <input type="password" class="form-input text-center pin-input" maxlength="1" inputmode="numeric" style="width: 56px; height: 56px; font-size: 28px; padding: 0;">
                                <input type="password" class="form-input text-center pin-input" maxlength="1" inputmode="numeric" style="width: 56px; height: 56px; font-size: 28px; padding: 0;">
                            </div>
                            <button onclick="setPin()" id="set-pin-btn" class="btn btn-primary w-full">
                                SAVE PIN
                            </button>
                        </div>
                        
                        <button onclick="cancelPinSetup()" class="btn btn-small mt-20" style="background: transparent; border: none; color: var(--text-dim); font-size: 11px;">
                            ← BACK TO OPTIONS
                        </button>
                    </div>
                    
                    <!-- Post PIN Success (Hidden initially) -->
                    <div id="post-pin-section" class="hidden" style="margin-top: var(--space-6);">
                        <div class="success-checkmark mb-20" style="width: 48px; height: 48px; margin: 0 auto; border-radius: 50%; background: var(--success); display: flex; align-items: center; justify-content: center;">
                            <svg style="width: 24px; height: 24px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                        <p class="text-white font-inter mb-4" style="font-weight: 500;">PIN Created Successfully!</p>
                        <p class="font-mono text-dim mb-20" style="font-size: 13px;">You can now log in quickly with your PIN.</p>
                        
                        <div class="flex flex-col" style="gap: var(--space-3);">
                            <a href="https://discord.gg/7HwhQaN6" target="_blank" class="btn btn-large w-full font-mono"
                                style="background: #5865F2; border-color: #5865F2; color: white;">
                                JOIN DISCORD COMMUNITY →
                            </a>
                            <a href="/" class="btn btn-large w-full font-mono"
                                style="background: transparent; border-color: var(--border); color: var(--text-main);">
                                EXPLORE THE STORE
                            </a>
                            <a href="/dashboard" class="btn w-full font-mono"
                                style="background: transparent; border: none; color: var(--text-dim); font-size: 12px;">
                                Go to Dashboard →
                            </a>
                        </div>
                    </div>
                    
                    <!-- Error message -->
                    <div id="error-message" class="hidden mt-20 p-10 rounded-8" style="background: rgba(230, 30, 37, 0.1); border: 1px solid var(--accent);">
                        <p class="font-mono text-sm" style="color: var(--accent);"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="col-span-12 department-footer mt-40 border-none" style="padding-bottom: 80px;">
            <div class="social-links mb-8">
                <a href="https://www.instagram.com/maya_lore_/" target="_blank" class="social-icon"
                    aria-label="Instagram">
                    <img src="https://cdn.jsdelivr.net/npm/remixicon@4.8.0/icons/Logos/instagram-line.svg"
                        alt="Instagram">
                </a>
                <a href="https://x.com/maya_lore_" target="_blank" class="social-icon" aria-label="X (Twitter)">
                    <img src="https://cdn.jsdelivr.net/npm/remixicon@4.8.0/icons/Logos/twitter-x-line.svg" alt="X">
                </a>
                <a href="https://discord.gg/7HwhQaN6" target="_blank" class="social-icon" aria-label="Discord">
                    <img src="https://cdn.jsdelivr.net/npm/remixicon@4.8.0/icons/Logos/discord-line.svg" alt="Discord">
                </a>
            </div>
            <p class="mb-8">DEPARTMENT OF LORE INC.</p>
            <p class="text-dim text-10">ANAND GANDHI & ZAIN MEMON /// MAYA NARRATIVE UNIVERSE</p>
            <div class="footer-links">
                <a href="/terms">Terms of Service</a>
                <a href="/privacy">Privacy Policy</a>
            </div>
        </div>
    </div>
    </div>

    <script>
        App.Cart.clear();
        
        // Fetch real order data
        async function loadOrderSummary() {
            try {
                const response = await fetch('/api/order/summary');
                if (response.ok) {
                    const data = await response.json();
                    if (data.id) {
                        // Format order ID
                        const orderId = 'PM-' + new Date().getFullYear() + '-' + String(data.id).padStart(5, '0');
                        document.getElementById('order-id').textContent = orderId;
                        
                        // Format date with timestamp
                        const orderDate = new Date(data.date || data.created_at);
                        const dateStr = orderDate.toLocaleDateString('en-US', { 
                            month: 'long', 
                            day: 'numeric', 
                            year: 'numeric' 
                        });
                        const timeStr = orderDate.toLocaleTimeString('en-US', { 
                            hour: 'numeric', 
                            minute: '2-digit',
                            hour12: true
                        });
                        document.getElementById('order-date').textContent = `${dateStr} at ${timeStr}`;
                        
                        // Display items
                        const itemsList = document.getElementById('order-items-list');
                        const items = data.items || [];
                        itemsList.innerHTML = items.map(item => `
                            <div class="flex justify-between items-center" style="padding-bottom: var(--space-3); margin-bottom: var(--space-3); border-bottom: 1px solid var(--border);">
                                <div class="flex-1">
                                    <div style="font-family: 'Inter', sans-serif; font-size: 14px; color: var(--text-main);">${item.name}</div>
                                    <div class="font-mono" style="font-size: 11px; color: var(--text-dim);">Qty: ${item.quantity || 1}</div>
                                </div>
                                <div class="font-mono" style="font-size: 14px; color: var(--text-main);">$${parseFloat(item.price || 0).toFixed(2)}</div>
                            </div>
                        `).join('');
                        
                        // Display totals
                        document.getElementById('order-subtotal').textContent = '$' + parseFloat(data.addonsSubtotal || 0).toFixed(2);
                        document.getElementById('order-shipping').textContent = '$' + parseFloat(data.shippingCost || 0).toFixed(2);
                        document.getElementById('order-total').textContent = '$' + parseFloat(data.total || 0).toFixed(2);
                        
                        // Display shipping address
                        const address = data.shippingAddress || {};
                        const addressHtml = `
                            <div class="text-white">${address.fullName || address.name || ''}</div>
                            <div>${address.addressLine1 || address.address_line1 || ''}</div>
                            ${address.addressLine2 || address.address_line2 ? `<div>${address.addressLine2 || address.address_line2}</div>` : ''}
                            <div>${address.city || ''}, ${address.state || ''} ${address.postalCode || address.postal_code || ''}</div>
                            <div>${address.country || ''}</div>
                            ${address.phone ? `<div class="mt-2">Phone: ${address.phone}</div>` : ''}
                        `;
                        document.getElementById('order-shipping-address').innerHTML = addressHtml;
                        
                        // Display payment method (if available)
                        const paymentMethod = data.paymentMethod || {};
                        const last4 = paymentMethod.last4 || '****';
                        const brand = paymentMethod.brand || 'card';
                        document.getElementById('order-payment-method').innerHTML = `
                            <svg style="width: 20px; height: 20px; color: var(--text-dim);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                            </svg>
                            <span>${brand.charAt(0).toUpperCase() + brand.slice(1)} •••• ${last4}</span>
                            <span style="margin-left: auto; font-size: 12px; color: var(--text-dim);">${data.status || 'Confirmed'}</span>
                        `;
                    } else {
                        // Fallback if no order found
                        document.getElementById('order-id').textContent = 'Confirmed';
                    }
                } else {
                    // Fallback
                    document.getElementById('order-id').textContent = 'Confirmed';
                }
            } catch (err) {
                console.error('Error loading order summary:', err);
                document.getElementById('order-id').textContent = 'Confirmed';
            }
        }

        loadOrderSummary();
        
        // Load user email for PIN setup
        let currentEmail = '';
        async function loadUserEmail() {
            try {
                const res = await fetch('/api/user/session');
                const data = await res.json();
                if (data.isLoggedIn && data.user?.email) {
                    currentEmail = data.user.email;
                    document.getElementById('user-email').textContent = currentEmail;
                } else {
                    // Try to get email from session storage (guest checkout)
                    const shippingData = sessionStorage.getItem('shippingAddress');
                    if (shippingData) {
                        const addr = JSON.parse(shippingData);
                        if (addr.email) {
                            currentEmail = addr.email;
                            document.getElementById('user-email').textContent = currentEmail;
                        }
                    }
                }
            } catch (err) {
                console.log('Could not load user email');
            }
        }
        loadUserEmail();
        
        // PIN input auto-advance
        function setupPinInputs() {
            const inputs = document.querySelectorAll('.pin-input');
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value.length === 0 && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
            });
        }
        setupPinInputs();
        
        function getPin() {
            const inputs = document.querySelectorAll('.pin-input');
            return Array.from(inputs).map(i => i.value).join('');
        }
        
        function showError(message) {
            const errEl = document.getElementById('error-message');
            errEl.querySelector('p').textContent = message;
            errEl.classList.remove('hidden');
            setTimeout(() => errEl.classList.add('hidden'), 5000);
        }
        
        function showPinSetup() {
            document.getElementById('initial-options').classList.add('hidden');
            document.getElementById('pin-setup-section').classList.remove('hidden');
        }
        
        function cancelPinSetup() {
            document.getElementById('pin-setup-section').classList.add('hidden');
            document.getElementById('initial-options').classList.remove('hidden');
            // Reset steps
            document.getElementById('otp-step').classList.remove('hidden');
            document.getElementById('verify-otp-step').classList.add('hidden');
            document.getElementById('set-pin-step').classList.add('hidden');
        }
        
        async function sendOtp() {
            const btn = document.getElementById('send-otp-btn');
            btn.textContent = 'SENDING...';
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/auth/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentEmail, forceOtp: true })
                });
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error);
                
                // Show OTP entry
                document.getElementById('otp-step').classList.add('hidden');
                document.getElementById('verify-otp-step').classList.remove('hidden');
                document.getElementById('otp-input').focus();
            } catch (err) {
                showError(err.message || 'Failed to send code');
                btn.textContent = 'SEND VERIFICATION CODE';
                btn.disabled = false;
            }
        }
        
        async function verifyOtp() {
            const btn = document.getElementById('verify-otp-btn');
            const otp = document.getElementById('otp-input').value;
            
            if (otp.length !== 4) {
                showError('Please enter the 4-digit code');
                return;
            }
            
            btn.textContent = 'VERIFYING...';
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/auth/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentEmail, otp })
                });
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error);
                
                // Show PIN setup
                document.getElementById('verify-otp-step').classList.add('hidden');
                document.getElementById('set-pin-step').classList.remove('hidden');
                document.querySelector('.pin-input').focus();
            } catch (err) {
                showError(err.message || 'Invalid code');
                btn.textContent = 'VERIFY CODE';
                btn.disabled = false;
            }
        }
        
        async function setPin() {
            const btn = document.getElementById('set-pin-btn');
            const pin = getPin();
            
            if (pin.length !== 4) {
                showError('Please enter a 4-digit PIN');
                return;
            }
            
            btn.textContent = 'SAVING...';
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/auth/set-pin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pin })
                });
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error);
                
                // Show success
                document.getElementById('pin-setup-section').classList.add('hidden');
                document.getElementById('post-pin-section').classList.remove('hidden');
            } catch (err) {
                showError(err.message || 'Failed to save PIN');
                btn.textContent = 'SAVE PIN';
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>